# üß¨ Malware Sample ‚Äì TFG Repository

This folder contains the source code for the custom malware sample developed as part of the final year thesis (TFG) on malware evasion techniques. The sample demonstrates multiple evasion, persistence, and propagation strategies, and is designed for educational and research purposes only.

---

## üìÅ Contents

- `dropperobs.cs`: Main dropper written in C#. It performs environment checks (sandbox, VM, debugger), validates its own hash with the C2 server, downloads and decrypts the payload and DLLs, and executes the payload in memory using reflection.
- `powerless.cs`: Stub DLL written in C# that uses the `System.Management.Automation` namespace to execute PowerShell scripts in memory. It is loaded reflectively by the dropper.
- `keyloggerv2.ps1`: PowerShell-based keylogger script. It is obfuscated and encrypted before being served by the C2 server.
- `dllmain.cpp`: DLL written in C++ used for DLL proxying. It executes the malware on load and forwards legitimate calls to the original DLL (used to hijack 7-Zip shell extension).

---

## üß† Key Features

### üîê Evasion Techniques

- AMSI bypass using memory patching and reflection.
- Obfuscation of PowerShell payload using Invoke-Obfuscation.
- Fileless execution via in-memory DLL loading.
- Anti-debugging, anti-sandbox, and VM detection (e.g., mouse movement, MAC prefixes, registry keys, WMI queries).

### üîÅ Persistence

- Scheduled task creation using PowerShell with hidden execution and registry manipulation.
- DLL proxying via 7-Zip shell extension hijack, ensuring execution on system startup.

### üåê Propagation

- SMB share enumeration and infection.
- Removable drive infection with social engineering (e.g., `fileRecovery.exe`).

---

## üß™ Execution Flow

1. Dropper verifies environment (sandbox, VM, debugger).
2. Validates its own hash with the C2 server.
3. Downloads and decrypts the payload and stub DLL.
4. Executes the PowerShell keylogger in memory.
5. Copies itself to SMB shares and removable drives.
6. Installs persistence via scheduled task and DLL hijack.

---

## üìö References

- [Trend Micro ‚Äì Detecting Windows AMSI Bypass Techniques](https://www.trendmicro.com/en_us/research/22/l/detecting-windows-amsi-bypass-techniques.html#:~:text=We%20look%20into%20some%20of%20the%20implementations%20that,it%20for%20compromise%20with%20Trend%20Micro%20Vision%20One%E2%84%A2.
)
- [SharpDllProxy ‚Äì DLL Proxying Generator by Flangvik](https://github.com/Flangvik/SharpDllProxy)
- [Powerless ‚Äì PowerShell Execution Stub (Gist)](https://gist.github.com/farzinenddo/bb1f1ecb56aa9326abc7b47fc99e588e)
- [PInvoke ‚Äì NetShareEnum API Reference](https://pinvoke.net/default.aspx/netapi32/netshareenum.html)
- [StackOverflow ‚Äì Enumerate Network Computers using NetServerEnum](https://stackoverflow.com/questions/20512242/find-all-computers-on-network-using-netserverenum)

---

## ‚ö†Ô∏è Disclaimer

This code is part of a cybersecurity research project and must only be used in isolated, controlled environments for educational purposes. Do not deploy or use this code in real-world systems.

---

